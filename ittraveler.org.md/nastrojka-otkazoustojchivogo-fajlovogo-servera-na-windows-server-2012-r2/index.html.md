# Настройка отказоустойчивого файлового сервера на Windows Server 2012 R2                	  
***Дата: 06.02.2015 Автор Admin***

В данной статье я расскажу как настроить отказоустойчивый файловый сервер на Windows Server 2012 R2 в домене Active Directory   Первым делом убедитесь что сервер введен в домен Active Directory, далее установите роли DFS и файлового сервера
Выберите следующие роли и установите их.
Далее создайте структуру папок на отдельном диске.
Теперь включим общий доступ.
Выберите &#171;расширенная настройка&#187;
Далее выберите &#171;Разрешения&#187; и установите права как на скриншоте.
Теперь нам нужно создать структуру прав для наших каталогов в Active Directory.
Для начала рассмотрим из чего состоит наша файловая структура.
Теперь на ее основе создадим в Active Directory OU &#8212; File Sharing
Переходим в консоль пользователи и компьютеры, и создаем OU
Аналогичным путем создадим структуру наших папок
Теперь создадим комплекты прав.
<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-1890562251101921"
data-ad-slot="9117958896"
data-ad-format="auto">
(adsbygoogle = window.adsbygoogle || []).push({});
Начнем мы с верхних папок.
Создадим 2-е локальные группы с правами RW и RO , и 2-е глобальные группы с правами RW и RO, и одну локальную L группу для листинга.
Разберем почему именно так.
В глобальных группах хранятся пользователи, для правильной работы глобальные группы входят в локальные.
Локальные группы назначаются на папки. Их членами являются глобальные группы.
Локальные группы лучше использовать если у вас 1 домен, если доменов несколько и между ними настроено доверие нужно использовать универсальные группы.
Рассмотрим на практике, создадим комплект прав для папки Office_Files.
Создадим 2-е глобальные группы :
GD-Office_Files-RO
GD-Office_Files-RW
Создадим локальные группы:
LD-Office_Files-RO
LD-Office_Files-RW
LD-Office_Files-L
Глобальные группы входят в локальные
Теперь настроим права на папке.
Откройте свойство папки и выберите вкладку безопасность
Добавьте созданные локальные группы
Расставьте права на чтение и запись
Теперь нажмите кнопку &#171;Дополнительно&#187;
Теперь нужно установить права на листинг
Выберите L группу и нажмите изменить
Теперь установите параметры как на скриншоте ниже
Обратите внимание что мы даем доступ только на листинг и только для данной папки.
Это нужно для того чтобы пользователь получивший права на папку не смог попасть в каталоги ниже если у него нет соответствующих прав.
Для корректной работы добавим в эту группу пользователей домена, чтобы они могли видеть корень каталога.
Также отключите наследование прав от корневого каталога диска.
По аналогии настроим права на каталог Moscow.
Создадим группы:
GD-Moscow-RO
GD-Moscow-RW
LD-Moscow-RO
LD-Moscow-RW
LD-Moscow-L
В Active Directory это должно выглядеть так:
Теперь настроим права на папку:
Настроим листинг.
Теперь настроим нижний каталог &#8212; HR.
Создаем группы по аналогии.
GD-MoscowHR-RO
GD-MoscowHR-RW
LD-MoscowHR-RO
LD-MoscowHR-RW
Должно получится так
Теперь добавим группы GD-MoscowHR-RO и GD-MoscowHR-RW в группу LD-Moscow-L
Это нужно для того чтобы пользователи у которых нет прав на папку Moscow могли попасть во вложенную папку HR.
При этом открывать файлы в папке Moscow они не смогут.
Настроим права на папку.
По аналогии создадим права на остальные папки.
Теперь добавим пространство имен.
Откроем консоль DFS и создадим пространство имен.
Указываем наш сервер.
&nbsp;
&nbsp;
Указываем название пути DFS.
Включаем режим 2008.
Создаем пространство.
Теперь создадим папку.
<ins class="adsbygoogle"
style="display:block"
data-ad-client="ca-pub-1890562251101921"
data-ad-slot="9117958896"
data-ad-format="auto">
(adsbygoogle = window.adsbygoogle || []).push({});
Далее указываем путь к папке. Путь можно посмотреть тут, выбрав &#171;open share&#187;.
Создаем папку.
Теперь по данному пути &#8212; \\test.com\office\Office Мы видим нашу общую папку.
Теперь если добавить пользователя в группу GD-MoscowHR-RW, он сможет попасть в папку HR, но не сможет открывать или редактировать файлы в папке Moscow.
В другие папки пользователь тоже попасть не сможет.
Если мы добавим пользователя в группу GD-Moscow-RW, он будет иметь доступ на всю папку Moscow, на чтение и запись.
Если мы добавим пользователя в группу GD-Office_Files-RW, он получит доступ ко всем каталогам.
Теперь рассмотрим настройку ABE.
Создайте следующую структуру в Active Directory.
Откройте общий доступ к папке.
Настройте права на папках.
И так далее.
Теперь создайте папку в DFS.
Должно получится так.
Теперь включим ABE.
В диспетчере сервера откройте &#171;Файловые службы&#187; &#8212; &#171;Общие ресурсы&#187;.
Выберите каталог IT, и нажмите свойства.
Далее выбираем параметры, и включаем функцию &#8212; &#171;Перечисление на основе доступа&#187;.
Особенность функции ABE в том что она проверяет права пользователя до того как нужно показать папки в проводнике.
Другими словами, пользователь видит только те папки на которые у него есть права.
Для примера дадим пользователю support права на папку Support (добавим его в группу &#8212; GD-IT-Support-RW)
Теперь перейдем по пути &#8212; \\test.com\office\IT
Как видите пользователь видит только папку Support.
Если мы добавим его в группу GD-IT-NetAdm-RO , то у него появится папка Network administrators с правами на чтение.
На этом настройка ABE закончена.
Учтите, что если в вашей файловой структуре нужно давать права пользователям на под каталоги, минуя корневые папки, то ABE вам не подойдет, т.к. ABE просто скроет от пользователя корневую папку, через которую пользователь попадает в подкаталог.
Перейдем в оснастку &#8212; Диспетчер ресурсов файлового сервера.
Настроим квоты.
Настроим мягкую квоту для папки Office_Files.
Настроим жесткую квоту для папки Support.
Теперь настроим блокировку файлов для папки Office_Files.
Выберем типы файлов, которые мы будем блокировать.
Настроим отправку сообщений по электронной почте.
Включим журнал.
Включим отчеты.
Учтите, без SMTP сервера отправка отчетов работать не будет.
Если вы хотите изменить группы файлов, то это можно сделать тут:
Создадим задачу управления файлами.
Представим что у нас есть папка Exchange. в которой пользователи обмениваются файлами.
Нам нужно сделать так, чтобы раз в период данная папка очищалась, а удаленные данные перемещались в папку Temp
Создаем задачу.
Задаем имя задачи.
Задаем путь и область.
Задаем свойства управления папками.
Задаем срок действия папки.
Настраиваем уведомление.
Задаем условие.
Настраиваем расписание.
Готово!
Теперь перейдем к настройке репликации.
Настройте сервер реплику (роли и доступы), введите его в домен.
Создаем на сервере реплике общую папку и отключаем наследование.
Назовем ее Office_Files, она будет репликой папки &#8212; Office_Files с основного файлового сервера.
Переходим на основной файловый сервер, и открываем консоль DFS.
Выбираем пространство имен, которое хотим реплицировать, и выбираем пункт &#171;Добавить конечный объект папки&#187;.
Указываем общую папку со 2-го сервера.
На вопрос о создании группы репликации отвечаем &#8212; да.
Оставляем заполненное по-умолчанию.
Проверяем что указаны 2-а наших сервера, основной и резервный.
Указываем основной сервер.
Выбираем топологию &#8212; полная сетка.
Выбираем пропускную способность канала между серверами.
Проверяем все, и выбираем &#8212; создать.
Если все прошло успешно, то вы увидите это:
Для отказоустойчивости добавим пространство имен для отображения, на 2-м нашем сервере.
И выберем наше пространство имен.
Должно получится так.
Теперь добавьте 2-й в &#171;серверы пространства имен&#187; на основном сервере.
Теперь пространство имен будет доступно на 2-х серверах.
Также обратите внимание, что настройки диспетчера ресурсов файлового сервера, настройки ABE, не реплицируются на 2-й сервер.
Настройку данного сервера нужно будет производить заново.
Также помните, что DFS репликация файлов работает по принципу &#8212; кто последний тот и прав.
Например, если 2 пользователя одновременно отредактируют или создадут один и тот же файл, то DFS реплицирует тот файл, который был создан последним.
А предыдущий файл будет сохранен в папке DfsrPrivate\ConflictandDeleted на сервере разрешившем проблему.
На этом все!  Удачной настройки!
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
