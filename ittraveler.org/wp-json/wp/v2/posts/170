{"id":170,"date":"2014-12-31T10:23:11","date_gmt":"2014-12-31T07:23:11","guid":{"rendered":"http:\/\/ittraveler.org\/?p=170"},"modified":"2015-05-28T17:05:41","modified_gmt":"2015-05-28T14:05:41","slug":"avtomatizaciya-sozdaniya-adresnyx-knig-v-office-365-cherez-powershell-chast-1","status":"publish","type":"post","link":"https:\/\/ittraveler.org\/avtomatizaciya-sozdaniya-adresnyx-knig-v-office-365-cherez-powershell-chast-1\/","title":{"rendered":"\u0410\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0437\u0430\u0446\u0438\u044f \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u044f \u0430\u0434\u0440\u0435\u0441\u043d\u044b\u0445 \u043a\u043d\u0438\u0433 \u0432 Office 365 \u0447\u0435\u0440\u0435\u0437 Powershell \u0427\u0430\u0441\u0442\u044c 1."},"content":{"rendered":"<p>\u0412 \u0434\u0430\u043d\u043d\u043e\u043c \u0446\u0438\u043a\u043b\u0435 \u0441\u0442\u0430\u0442\u0435\u0439 \u044f \u043f\u043e\u043a\u0430\u0436\u0443 \u043a\u0430\u043a \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043f\u0440\u043e\u0446\u0435\u0441\u0441 \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u044f, \u0443\u0434\u0430\u043b\u0435\u043d\u0438\u044f, \u0430\u043a\u0442\u0443\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u0438 \u0430\u0434\u0440\u0435\u0441\u043d\u044b\u0445 \u043a\u043d\u0438\u0433 \u0432 Office 365.<\/p>\n<p>\u0418\u043c\u0435\u0435\u043c \u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0443\u044e \u0441\u0445\u0435\u043c\u0443:<\/p>\n<p>1) \u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0438 \u0441\u0438\u043d\u0445\u0440\u043e\u043d\u0438\u0437\u0438\u0440\u0443\u044e\u0442\u0441\u044f \u0438\u0437 \u043b\u043e\u043a\u0430\u043b\u044c\u043d\u043e\u0439 AD, \u043a\u0430\u0436\u0434\u044b\u0439 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043d\u0430\u0445\u043e\u0434\u0438\u0442\u0441\u044f \u0432 \u0441\u0432\u043e\u0435\u0439 OU \u0441 \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435\u043c \u0435\u0433\u043e \u043a\u043e\u043c\u043f\u0430\u043d\u0438\u0438, \u0438 \u0441\u043e\u0441\u0442\u043e\u0438\u0442 \u0432 2-\u0445 \u0433\u0440\u0443\u043f\u043f\u0430\u0445 (\u043f\u043e 2-\u0435 \u0433\u0440\u0443\u043f\u043f\u044b \u043d\u0430 \u043a\u0430\u0436\u0434\u0443\u044e \u043a\u043e\u043c\u043f\u0430\u043d\u0438\u044e)<\/p>\n<p>2) \u041d\u0430\u043c \u043d\u0443\u0436\u043d\u043e \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043f\u0440\u043e\u0446\u0435\u0441\u0441 \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u044f \u0438\u043d\u0434\u0438\u0432\u0438\u0434\u0443\u0430\u043b\u044c\u043d\u044b\u0445 \u0430\u0434\u0440\u0435\u0441\u043d\u044b\u0445 \u043a\u043d\u0438\u0433 \u0434\u043b\u044f \u043a\u0430\u0436\u0434\u043e\u0439 \u043a\u043e\u043c\u043f\u0430\u043d\u0438\u0438 (OU).<\/p>\n<p><!--more--><\/p>\n<p>\u0418\u0442\u0430\u043a, \u043d\u0430\u043c \u043d\u0443\u0436\u043d\u043e:<\/p>\n<p>1) \u0421\u043e\u0437\u0434\u0430\u0432\u0430\u0442\u044c \u043d\u043e\u0432\u044b\u0435 \u0430\u0434\u0440\u0435\u0441\u043d\u044b\u0435 \u043a\u043d\u0438\u0433\u0438<\/p>\n<p>2) \u0423\u0434\u0430\u043b\u044f\u0442\u044c \u043d\u0435\u0430\u043a\u0442\u0443\u0430\u043b\u044c\u043d\u044b\u0435 \u0430\u0434\u0440\u0435\u0441\u043d\u044b\u0435 \u043a\u043d\u0438\u0433\u0438<\/p>\n<p>3) \u0414\u043e\u0431\u0430\u0432\u043b\u044f\u0442\u044c \u043d\u043e\u0432\u044b\u043c \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\u043c \u043f\u043e\u043b\u0438\u0442\u0438\u043a\u0443 \u0430\u0434\u0440\u0435\u0441\u043d\u044b\u0445 \u043a\u043d\u0438\u0433 \u0438\u0445 \u043a\u043e\u043c\u043f\u0430\u043d\u0438\u0438.<\/p>\n<p>4) \u0421\u0434\u0435\u043b\u0430\u0442\u044c \u0442\u0430\u043a, \u0447\u0442\u043e\u0431\u044b \u043a\u0430\u0436\u0434\u0430\u044f \u043a\u043e\u043c\u043f\u0430\u043d\u0438\u044f \u0432\u0438\u0434\u0435\u043b\u0430 \u0442\u043e\u043b\u044c\u043a\u043e \u0441\u0432\u043e\u044e \u0430\u0434\u0440\u0435\u0441\u043d\u0443\u044e \u043a\u043d\u0438\u0433\u0443.<\/p>\n<p>\u0412 \u044d\u0442\u043e\u0439 \u0441\u0442\u0430\u0442\u044c\u0435 \u044f \u043f\u043e\u043a\u0430\u0436\u0443 \u043a\u0430\u043a \u0441\u043e\u0437\u0434\u0430\u0432\u0430\u0442\u044c \u0430\u0434\u0440\u0435\u0441\u043d\u044b\u0435 \u043a\u043d\u0438\u0433\u0438 \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438.<\/p>\n<p>\u0410\u043b\u0433\u043e\u0440\u0438\u0442\u043c \u0441\u043a\u0440\u0438\u043f\u0442\u0430 \u0431\u0443\u0434\u0435\u0442 \u0442\u0430\u043a\u0438\u043c:<\/p>\n<p>1) \u0421\u043e\u0437\u0434\u0430\u0435\u043c CSV \u0444\u0430\u0439\u043b, \u0432 \u043a\u043e\u0442\u043e\u0440\u044b\u0439 \u0431\u0443\u0434\u0443\u0442 \u0437\u0430\u043f\u0438\u0441\u044b\u0432\u0430\u0442\u044c\u0441\u044f \u0433\u0440\u0443\u043f\u043f\u044b AD (\u0442\u0435 2-\u0435 \u0433\u0440\u0443\u043f\u043f\u044b \u0432 \u043a\u0430\u0436\u0434\u043e\u0439 \u043a\u043e\u043c\u043f\u0430\u043d\u0438\u0438)<\/p>\n<p>2) \u0411\u0443\u0434\u0435\u043c \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0442\u044c \u043d\u0435 \u0432\u0441\u0435 \u0433\u0440\u0443\u043f\u043f\u044b \u043f\u043e\u0434\u0440\u044f\u0434, \u0430 \u0442\u043e\u043b\u044c\u043a\u043e \u0433\u0440\u0443\u043f\u043f\u044b \u0441 \u0437\u0430\u043c\u0435\u0442\u043a\u043e\u0439 (\u0432 \u0441\u0432\u043e\u0439\u0441\u0442\u0432\u0430\u0445 \u0433\u0440\u0443\u043f\u043f\u044b) test.com<\/p>\n<p>3) \u041f\u043e\u0434\u043a\u043b\u044e\u0447\u0430\u0435\u043c\u0441\u044f \u043a Office 365<\/p>\n<p>4) \u0421\u0438\u043d\u0445\u0440\u043e\u043d\u0438\u0437\u0438\u0440\u0443\u0435\u043c \u043b\u043e\u043a\u0430\u043b\u044c\u043d\u0443\u044e AD \u0441 Office 365<\/p>\n<p>5) \u0418\u043c\u043f\u043e\u0440\u0442\u0438\u0440\u0443\u0435\u043c CSV \u0438 \u043d\u0430 \u0435\u0433\u043e \u043e\u0441\u043d\u043e\u0432\u0435 \u0441\u043e\u0437\u0434\u0430\u0435\u043c \u0430\u0434\u0440\u0435\u0441\u043d\u044b\u0435 \u043a\u043d\u0438\u0433\u0438 (\u0434\u043b\u044f \u043a\u0430\u0436\u0434\u043e\u0439 \u0433\u0440\u0443\u043f\u043f\u044b \u0441\u0432\u043e\u044f \u0430\u0434\u0440\u0435\u0441\u043d\u0430\u044f \u043a\u043d\u0438\u0433\u0430)<\/p>\n<p>6) \u0422.\u043a. \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0438 \u0443\u0436\u0435 \u0432\u0445\u043e\u0434\u044f\u0442 \u0432 \u044d\u0442\u0438 \u0433\u0440\u0443\u043f\u043f\u044b, \u043e\u043d\u0438 \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u0441\u0442\u0430\u043d\u0443\u0442 \u0447\u043b\u0435\u043d\u0430\u043c\u0438 \u0430\u0434\u0440\u0435\u0441\u043d\u043e\u0439 \u043a\u043d\u0438\u0433\u0438<\/p>\n<p>7) \u041f\u0440\u0438\u043c\u0435\u043d\u044f\u0435\u043c \u043f\u043e\u043b\u0438\u0442\u0438\u043a\u0443 \u0430\u0434\u0440\u0435\u0441\u043d\u044b\u0445 \u043a\u043d\u0438\u0433 \u043d\u0430 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439<\/p>\n<p>8) \u0421\u043e\u0437\u0434\u0430\u0435\u043c Powershell \u0441\u043a\u0440\u0438\u043f\u0442, \u043a\u043e\u0442\u043e\u0440\u044b\u0439 \u0431\u0443\u0434\u0435\u0442 \u043f\u0440\u0438\u043c\u0435\u043d\u044f\u0442\u044c \u043d\u043e\u0432\u044b\u043c \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\u043c \u043f\u043e\u043b\u0438\u0442\u0438\u043a\u0443 \u0430\u0434\u0440\u0435\u0441\u043d\u044b\u0445 \u043a\u043d\u0438\u0433.<\/p>\n<p>\u0421\u0430\u043c \u0441\u043a\u0440\u0438\u043f\u0442:<\/p>\n<pre class=\"\">#Delete OLD Sessions \r\n\r\nRemove-PSSession $Session\r\n\r\n$AdminUsername = \"LOGIN@test.com\"\r\n$AdminPassword = \"PASS\"\r\n\r\n$CSVpatch = \"C:\\PowerShell_Scripts\\123.csv\"\r\n\r\n#Add Groups with Attribute Info to CSV\r\n\r\nRemove-Item $CSVpatch\r\n\r\nGet-ADGroup -Filter {info -eq 'test.com'} -SearchBase \"OU=Office365_Sync,DC=test,DC=local\" -Properties Name, Description | select Name, Description | export-csv  -Encoding UTF8 -NoTypeInformation -Delimiter \";\"  $CSVpatch \r\n\r\n#Connect to Office 365\r\n$SecurePassword = ConvertTo-SecureString $AdminPassword -AsPlainText -Force\r\n$cred = New-Object -TypeName System.Management.Automation.PSCredential -argumentlist $AdminUsername,$SecurePassword\r\n\r\n$Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri \"https:\/\/ps.outlook.com\/powershell\" -Credential $cred -Authentication Basic -AllowRedirection\r\n\r\nImport-PSSession $Session\r\n\r\nImport-Module MSOnline\r\n\r\nConnect-MSOLService -Credential $cred\r\n\r\n#Sync Local AD with Office 365 \r\n\r\nImport-Module DirSync\r\n\r\nStart-OnlineCoexistenceSync\r\n\r\nImport-Csv $CSVpatch -Delimiter \";\"| % {\r\n\r\n$ADgroup = $_.Name; # Set the Name\r\n$DisplayName = $_.Description; # Set the Description\r\n\r\n#set group DN\r\n$dn = (Get-DistributionGroup $ADgroup).distinguishedName\r\n\r\n#Create New Resourse address list\r\nNew-AddressList -Name \"$ADgroup.res\" -RecipientFilter \"RecipientDisplayType -eq 'ConferenceRoomMailbox' -and memberOfGroup -eq '$dn'\" -DisplayName \"$DisplayName \u0420\u0435\u0441\u0443\u0440\u0441\u044b\"\r\n\r\n#Create New Address List\r\nNew-AddressList -Name \"$ADgroup\" -DisplayName \"$DisplayName\" -RecipientFilter \"{(RecipientType -eq 'UserMailbox' -or RecipientType -eq 'MailUniversalDistributionGroup') -and memberOfGroup -eq '$dn'}\"\r\n\r\n#Create New GAL\r\nNew-GlobalAddressList -Name \"$ADgroup.gal\" -RecipientFilter \"MemberOfGroup -eq '$dn'\"\r\n\r\n#Create Offline Address Book\r\nNew-OfflineAddressBook -Name \"$ADgroup.Oab\" -AddressLists \"$ADgroup.gal\"\r\n\r\n#Create Address Book Policy\r\n\r\nNew-AddressBookPolicy -Name \"$ADgroup.Abp\" -AddressLists \"$ADgroup\" -OfflineAddressBook \"\\$ADgroup.Oab\" -GlobalAddressList \"\\$ADgroup.gal\" -RoomList \"\\$ADgroup.res\"\r\n\r\n#Set Username Variable\r\n$username=[Environment]::UserName\r\n\r\n#Delete Temp file\r\nRemove-Item C:\\Users\\$username\\TEMP\r\n\r\n#Get Object ID from AD cloud group\r\nGet-MsolGroup | Where-Object {$_.DisplayName -eq \"$ADgroup\"} | select ObjectId | Out-File -FilePath C:\\Users\\$username\\TEMP\r\n$ObjectID=(Get-Content C:\\Users\\$username\\TEMP)[3]\r\necho $ObjectID\r\n#Select New Address Book Policy to users in AD Group\r\nGet-Mailbox -ResultSize unlimited | Where-Object {$_.ExternalDirectoryObjectId -in (Get-MsolGroupMember -GroupObjectId $ObjectID).objectid} | Set-Mailbox -AddressBookPolicy \"$ADgroup.Abp\"\r\n\r\n#Add shedule task to automate script\r\n\r\necho \" `n\" &gt;&gt; C:\\PowerShell_Scripts\\Add-AddressBookPolicy-Via-ADgroup.ps1\r\n$ObjectID= $ObjectID.Trim()\r\n\r\nRemove-Item C:\\PowerShell_Scripts\\TEMPshedule.ps1\r\nGet-Content C:\\PowerShell_Scripts\\Add-AddressBookPolicy-Via-ADgroup.ps1 &gt; C:\\PowerShell_Scripts\\TEMPshedule.ps1\r\nRemove-Item C:\\PowerShell_Scripts\\Add-AddressBookPolicy-Via-ADgroup.ps1\r\nmv C:\\PowerShell_Scripts\\TEMPshedule.ps1 C:\\PowerShell_Scripts\\Add-AddressBookPolicy-Via-ADgroup.ps1\r\n$_='$_'\r\necho \"Get-Mailbox -ResultSize unlimited | Where-Object {$_.ExternalDirectoryObjectId -in (Get-MsolGroupMember -GroupObjectId $ObjectID).objectid} | Set-Mailbox -AddressBookPolicy $ADgroup.Abp\" &gt;&gt; C:\\PowerShell_Scripts\\Add-AddressBookPolicy-Via-ADgroup.ps1\r\n\r\nRemove-Item C:\\PowerShell_Scripts\\TEMPshedule.ps1\r\n\r\n#Remove Temp File\r\nRemove-Item C:\\Users\\$username\\TEMP\r\n\r\n}\r\n\r\nRemove-PSSession $Session\r\nRemove-Item $CSVpatch<\/pre>\n<p>\u0412 \u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0435\u0439 \u0441\u0442\u0430\u0442\u044c\u0435 \u043c\u044b \u0440\u0430\u0441\u0441\u043c\u043e\u0442\u0440\u0438\u043c \u043a\u0430\u043a \u0443\u0434\u0430\u043b\u044f\u0442\u044c \u043d\u0435\u0430\u043a\u0442\u0443\u0430\u043b\u044c\u043d\u044b\u0435 \u0430\u0434\u0440\u0435\u0441\u043d\u044b\u0435 \u043a\u043d\u0438\u0433\u0438.<br \/>\n\u041d\u0435 \u0437\u0430\u0431\u044b\u0432\u0430\u0439\u0442\u0435 \u0432 \u0441\u043a\u0440\u0438\u043f\u0442\u0430\u0445 \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0442\u044c \u0441\u0432\u043e\u0438 \u043f\u0443\u0442\u0438 \u0438 \u043f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u044b\u0435, \u0438\u043d\u0430\u0447\u0435 \u043d\u0438\u0447\u0435\u0433\u043e \u043d\u0435 \u0437\u0430\u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442!<\/p>\n","protected":false},"excerpt":{"rendered":"<p>\u0412 \u0434\u0430\u043d\u043d\u043e\u043c \u0446\u0438\u043a\u043b\u0435 \u0441\u0442\u0430\u0442\u0435\u0439 \u044f \u043f\u043e\u043a\u0430\u0436\u0443 \u043a\u0430\u043a \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043f\u0440\u043e\u0446\u0435\u0441\u0441 \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u044f, \u0443\u0434\u0430\u043b\u0435\u043d\u0438\u044f, \u0430\u043a\u0442\u0443\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u0438 \u0430\u0434\u0440\u0435\u0441\u043d\u044b\u0445 \u043a\u043d\u0438\u0433 \u0432 Office 365. \u0418\u043c\u0435\u0435\u043c \u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0443\u044e \u0441\u0445\u0435\u043c\u0443: 1) \u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0438 \u0441\u0438\u043d\u0445\u0440\u043e\u043d\u0438\u0437\u0438\u0440\u0443\u044e\u0442\u0441\u044f \u0438\u0437 \u043b\u043e\u043a\u0430\u043b\u044c\u043d\u043e\u0439 AD, \u043a\u0430\u0436\u0434\u044b\u0439 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043d\u0430\u0445\u043e\u0434\u0438\u0442\u0441\u044f \u0432 \u0441\u0432\u043e\u0435\u0439 OU \u0441 \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435\u043c \u0435\u0433\u043e \u043a\u043e\u043c\u043f\u0430\u043d\u0438\u0438, \u0438 \u0441\u043e\u0441\u0442\u043e\u0438\u0442 \u0432 2-\u0445 \u0433\u0440\u0443\u043f\u043f\u0430\u0445 (\u043f\u043e 2-\u0435 \u0433\u0440\u0443\u043f\u043f\u044b \u043d\u0430 \u043a\u0430\u0436\u0434\u0443\u044e \u043a\u043e\u043c\u043f\u0430\u043d\u0438\u044e) 2) \u041d\u0430\u043c \u043d\u0443\u0436\u043d\u043e \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043f\u0440\u043e\u0446\u0435\u0441\u0441 \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u044f \u0438\u043d\u0434\u0438\u0432\u0438\u0434\u0443\u0430\u043b\u044c\u043d\u044b\u0445 \u0430\u0434\u0440\u0435\u0441\u043d\u044b\u0445<\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[9,59,5],"tags":[25,63,60,64],"class_list":["post-170","post","type-post","status-publish","format-standard","hentry","category-active-directory","category-office-365","category-powershell","tag-active-directory","tag-exchange-online","tag-office-365","tag-powershell","post-container col-md-12"],"aioseo_notices":[],"_links":{"self":[{"href":"https:\/\/ittraveler.org\/wp-json\/wp\/v2\/posts\/170","targetHints":{"allow":["GET"]}}],"collection":[{"href":"https:\/\/ittraveler.org\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/ittraveler.org\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/ittraveler.org\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/ittraveler.org\/wp-json\/wp\/v2\/comments?post=170"}],"version-history":[{"count":4,"href":"https:\/\/ittraveler.org\/wp-json\/wp\/v2\/posts\/170\/revisions"}],"predecessor-version":[{"id":565,"href":"https:\/\/ittraveler.org\/wp-json\/wp\/v2\/posts\/170\/revisions\/565"}],"wp:attachment":[{"href":"https:\/\/ittraveler.org\/wp-json\/wp\/v2\/media?parent=170"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/ittraveler.org\/wp-json\/wp\/v2\/categories?post=170"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/ittraveler.org\/wp-json\/wp\/v2\/tags?post=170"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}